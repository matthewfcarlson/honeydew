name: PR Screenshots

on:
  pull_request:
    branches: [ "main" ]

permissions:
  contents: read
  pull-requests: write

jobs:
  screenshots:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Use Node.js 22.x
      uses: actions/setup-node@v4
      with:
        node-version: 22.x

    - name: Install dependencies
      run: npm install

    - name: Install Playwright browsers
      run: npx playwright install --with-deps chromium

    - name: Build frontend
      run: npm run build

    - name: Run screenshot tests
      run: npx playwright test

    - name: Upload screenshots
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: screenshots
        path: screenshots/
        retention-days: 30

    - name: Comment on PR with screenshots
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const path = require('path');

          const screenshotDir = 'screenshots';
          if (!fs.existsSync(screenshotDir)) {
            console.log('No screenshots directory found');
            return;
          }

          const files = fs.readdirSync(screenshotDir)
            .filter(f => f.endsWith('.png'))
            .sort();

          if (files.length === 0) {
            console.log('No screenshots found');
            return;
          }

          const runUrl = `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
          const artifactName = 'screenshots';

          // Build the comment body
          let body = `## ðŸ“¸ Screenshots\n\n`;
          body += `Screenshots captured from this PR's build.\n\n`;
          body += `| Page | Screenshot |\n`;
          body += `|------|------------|\n`;

          const labels = {
            '01-landing': 'Landing Page',
            '02-signup': 'Signup Page',
            '03-signup-success': 'Signup Success',
            '04-home-dashboard': 'Home Dashboard',
            '05-chores': 'Chores',
            '06-recipes': 'Recipes',
            '07-projects': 'Projects',
            '08-household': 'Household',
          };

          for (const file of files) {
            const name = path.basename(file, '.png');
            const label = labels[name] || name;
            body += `| ${label} | âœ… Captured |\n`;
          }

          body += `\n[ðŸ“¥ Download all screenshots](${runUrl}#artifacts)\n`;
          body += `\n<sub>Generated by the PR Screenshots workflow</sub>`;

          // Find existing bot comment to update
          const { data: comments } = await github.rest.issues.listComments({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number,
          });

          const botComment = comments.find(c =>
            c.user.type === 'Bot' && c.body.includes('## ðŸ“¸ Screenshots')
          );

          if (botComment) {
            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: botComment.id,
              body,
            });
          } else {
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body,
            });
          }
